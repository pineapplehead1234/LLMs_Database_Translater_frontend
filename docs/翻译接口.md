# ç¿»è¯‘åº”ç”¨APIæ¥å£æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **é¡¹ç›®åç§°**: ç¿»è¯‘åº”ç”¨ API
- **ç‰ˆæœ¬**: 1.0.0 - MVP
- **Base URL**: `http://localhost:8000`
- **Content-Type**: `multipart/form-data` (ä¸Šä¼ ) / `text/event-stream` (SSE)
- **ç¿»è¯‘æ–¹å‘é»˜è®¤**: è‹±æ–‡(en) â†’ ä¸­æ–‡(zh)
- **è®¤è¯**: æ— éœ€ç™»å½•ï¼ˆMVPé˜¶æ®µï¼‰

---

## ğŸ”„ æ¥å£è®¾è®¡åŸåˆ™

### å‰ç«¯æœ¬åœ°ç®¡ç† vs åç«¯æ•°æ®æä¾›

**å‰ç«¯æœ¬åœ°ç®¡ç†ï¼ˆå‰ç«¯è‡ªè¡Œå¤„ç†ï¼‰ï¼š**
- æ–‡ä»¶æ ‘ç»“æ„ (`TreeNode`)
- æ–‡ä»¶çŠ¶æ€ç®¡ç†
- ç¿»è¯‘è®°å½•å­˜å‚¨ (`TranslationRecord`)
- æ–‡ä»¶å¤¹ç®¡ç†
- IndexedDBç¼“å­˜

**åç«¯æ•°æ®æä¾›ï¼ˆAPIæ¥å£ï¼‰ï¼š**
- ç¿»è¯‘ç»“æœï¼ˆMarkdown + ZIPåŒ…ä¸‹è½½åœ°å€ï¼‰
- ä»»åŠ¡è¿›åº¦çŠ¶æ€
- å¼‚æ­¥ä»»åŠ¡ID

---

## ğŸ“¤ æ–‡ä»¶ä¸Šä¼ æ¥å£ï¼ˆå¼‚æ­¥ï¼‰

### POST /api/task/upload

**åŠŸèƒ½æè¿°**: ä¸Šä¼ æ–‡ä»¶å¹¶å¯åŠ¨å¼‚æ­¥ç¿»è¯‘ä»»åŠ¡

**æ”¯æŒæ ¼å¼**: PDF, DOCX, Markdown (.md)

---

### è¯·æ±‚å‚æ•°ï¼ˆmultipart/form-dataï¼‰

| å‚æ•°å | ç±»å‹ | æ˜¯å¦å¿…éœ€ | è¯´æ˜ | æä¾›æ–¹ |
|--------|------|---------|------|--------|
| file | File | âœ… å¿…éœ€ | ä¸Šä¼ çš„æ–‡ä»¶ | å‰ç«¯ |
| target_lang | string | âœ… å¿…éœ€ | ç›®æ ‡è¯­è¨€ï¼ˆå¦‚ 'ch'ï¼‰ | å‰ç«¯ |
| strategy | string | âŒ å¯é€‰ | ç¿»è¯‘ç­–ç•¥ï¼ˆé»˜è®¤ 'normal'ï¼‰ | å‰ç«¯ |

---

### è¯·æ±‚ç¤ºä¾‹

```javascript
const formData = new FormData()
formData.append('file', file)
formData.append('target_lang', 'ch')
formData.append('strategy', 'normal')

fetch('/apiA/api/task/upload', {
  method: 'POST',
  body: formData
})
```

---

### å“åº”æ ¼å¼ï¼ˆç®€å•å“åº”ï¼‰

```typescript
interface UploadResponse {
  status: 'success' | 'error'
  taskId?: string    // æˆåŠŸæ—¶è¿”å›å¼‚æ­¥ä»»åŠ¡ID
  error?: string     // å¤±è´¥æ—¶è¿”å›é”™è¯¯ä¿¡æ¯
}
```

**æˆåŠŸå“åº”ï¼š**
```json
{
  "status": "success",
  "taskId": "task_123_456789"
}
```

**å¤±è´¥å“åº”ï¼š**
```json
{
  "status": "error",
  "error": "æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶"
}
```

---

## ğŸ“¡ SSEè¿›åº¦æŸ¥è¯¢æ¥å£

### GET /api/task/progress?taskId={taskId}

**åŠŸèƒ½æè¿°**: é€šè¿‡SSEæµå®æ—¶è·å–ç¿»è¯‘è¿›åº¦å’Œç»“æœ

---

### SSEå“åº”æ ¼å¼

```typescript
interface TaskProgressResponse {
  status: 'pending' | 'processing' | 'completed' | 'error'
  progress?: number
  message?: string

  // ç¿»è¯‘å®Œæˆæ—¶æä¾›
  result?: {
    originalMarkdown: string
    translatedMarkdown: string
    zipUrl: string           // ZIPåŒ…ä¸‹è½½åœ°å€
    termAnnotations?: TermAnnotation[] // æœ¯è¯­æ ‡æ³¨ï¼ˆå¯é€‰ï¼‰
  }

  error?: string
}

// æœ¯è¯­æ ‡æ³¨ç»“æ„
interface TermAnnotation {
  term: string             // åŸæ–‡æœ¯è¯­
  translation: string      // è¯‘æ–‡æœ¯è¯­
  position: {
    start: number         // åœ¨åŸæ–‡ä¸­çš„èµ·å§‹ä½ç½®
    end: number           // åœ¨åŸæ–‡ä¸­çš„ç»“æŸä½ç½®
  }
}
```

---

### SSEå“åº”ç¤ºä¾‹

#### 1. ä»»åŠ¡å¼€å§‹
```json
{
  "status": "pending",
  "progress": 0,
  "message": "ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨æ’é˜Ÿ"
}
```

#### 2. å¤„ç†ä¸­
```json
{
  "status": "processing",
  "progress": 45,
  "message": "æ­£åœ¨è§£ææ–‡æ¡£å†…å®¹"
}
```

#### 3. ç¿»è¯‘å®Œæˆ
```json
{
  "status": "completed",
  "progress": 100,
  "result": {
    "originalMarkdown": "# Machine Learning\n\nML is important.\n\n![Diagram](./images/ml.png)",
    "translatedMarkdown": "# æœºå™¨å­¦ä¹ \n\næœºå™¨å­¦ä¹ å¾ˆé‡è¦ã€‚\n\n![Diagram](./images/ml.png)",
    "zipUrl": "/api/files/assets/task_123_456789_assets.zip",
    "termAnnotations": [
      {
        "term": "Machine Learning",
        "translation": "æœºå™¨å­¦ä¹ ",
        "position": {
          "start": 2,
          "end": 17
        }
      },
      {
        "term": "ML",
        "translation": "æœºå™¨å­¦ä¹ ",
        "position": {
          "start": 19,
          "end": 21
        }
      }
    ]
  }
}
```

#### 4. å¤„ç†å¤±è´¥
```json
{
  "status": "error",
  "error": "æ–‡æ¡£è§£æå¤±è´¥ï¼šä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼"
}
```

---

## ğŸ“¦ ZIPèµ„æºä¸‹è½½æ¥å£

### GET /api/files/assets/{taskId}_assets.zip

**åŠŸèƒ½æè¿°**: ä¸‹è½½åŒ…å«æ–‡æ¡£ä¸­æ‰€æœ‰å›¾ç‰‡çš„ZIPå‹ç¼©åŒ…

**URLå‚æ•°ï¼š**
- `taskId`: ä»»åŠ¡IDï¼ˆç”¨äºæ„é€ æ–‡ä»¶åï¼‰

**å“åº”ï¼š**
- Content-Type: `application/zip`
- Content-Disposition: `attachment; filename="{taskId}_assets.zip"`
- Body: ZIPæ–‡ä»¶äºŒè¿›åˆ¶æ•°æ®

---

### ZIPåŒ…å†…éƒ¨ç»“æ„

**æ–‡ä»¶ç»„ç»‡ï¼š**
```
{taskId}_assets.zip/
â””â”€â”€ images/              # å›¾ç‰‡ç›®å½•
    â”œâ”€â”€ flowchart.png   # ä¿æŒåŸå§‹æ–‡ä»¶å
    â”œâ”€â”€ diagram.jpg
    â””â”€â”€ chart.png
```

**æ˜ å°„è§„åˆ™ï¼š**
- ZIPå†…è·¯å¾„ï¼š`images/{filename}`
- Markdownè·¯å¾„ï¼š`./images/{filename}`
- å‰ç«¯è‡ªåŠ¨æ ¹æ®æ–‡ä»¶åæ˜ å°„ï¼Œæ— éœ€é¢å¤–å…ƒæ•°æ®æ–‡ä»¶

**å‰ç«¯å¤„ç†ç¤ºä¾‹ï¼š**
```typescript
// æ— éœ€metadata.jsonï¼Œç›´æ¥éå†ZIPåŒ…
async function processZipPackage(zipBlob: Blob) {
  const zip = await JSZip.loadAsync(zipBlob)
  const pathMapping: Record<string, string> = {}

  // éå†imagesç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
  Object.keys(zip.files).forEach(async (path) => {
    if (path.startsWith('images/') && !path.endsWith('/')) {
      const filename = path.replace('images/', '')
      const file = zip.files[path]

      // åˆ›å»ºblob URL
      const blob = await file.async('blob')
      const blobUrl = URL.createObjectURL(blob)

      // å»ºç«‹æ˜ å°„å…³ç³»ï¼š./images/filename â†’ blobUrl
      pathMapping[`./images/${filename}`] = blobUrl

      // ç¼“å­˜åˆ°IndexedDB
      await ImageCache.saveImage(`img_${Date.now()}`, blob)
    }
  })

  return pathMapping
}
```

---

## ğŸ“Š æ•°æ®æµè½¬è¯´æ˜

### å‰ç«¯æ–‡ä»¶æ ‘ç®¡ç†ï¼ˆæœ¬åœ°ï¼‰

```typescript
// å‰ç«¯æœ¬åœ°ç»´æŠ¤çš„æ–‡ä»¶æ ‘ç»“æ„
interface TreeNode {
  id: string              // å‰ç«¯ç”Ÿæˆï¼šå”¯ä¸€ID
  name: string            // å‰ç«¯ç”Ÿæˆï¼šæ˜¾ç¤ºåç§°
  type: 'folder' | 'file' // å‰ç«¯ç”Ÿæˆï¼šèŠ‚ç‚¹ç±»å‹
  fileType?: 'pdf' | 'docx' | 'md'  // å‰ç«¯ç”Ÿæˆï¼šæ–‡ä»¶ç±»å‹
  status?: 'pending' | 'processing' | 'completed' | 'error'  // å‰ç«¯ç®¡ç†ï¼šç¿»è¯‘çŠ¶æ€
  parentId: string | null // å‰ç«¯ç®¡ç†ï¼šçˆ¶èŠ‚ç‚¹
  children?: TreeNode[]   // å‰ç«¯ç®¡ç†ï¼šå­èŠ‚ç‚¹
  translationId?: string  // å‰ç«¯å…³è”ï¼šç¿»è¯‘è®°å½•ID
}
```

### å‰ç«¯ç¿»è¯‘è®°å½•å­˜å‚¨ï¼ˆæœ¬åœ°ï¼‰

```typescript
// å‰ç«¯æœ¬åœ°å­˜å‚¨çš„ç¿»è¯‘ç»“æœ
interface TranslationRecord {
  id: string              // å‰ç«¯ç”Ÿæˆï¼šè®°å½•ID
  title: string           // å‰ç«¯ç”Ÿæˆï¼šæ ‡é¢˜
  originalText: string    // ä»SSEè·å–ï¼šåŸæ–‡
  translatedText: string  // ä»SSEè·å–ï¼šè¯‘æ–‡
  sourceLang: string      // å‰ç«¯è®¾ç½®ï¼šæºè¯­è¨€
  targetLang: string      // å‰ç«¯è®¾ç½®ï¼šç›®æ ‡è¯­è¨€
  folderPath: string      // å‰ç«¯ç®¡ç†ï¼šæ–‡ä»¶å¤¹è·¯å¾„
  termAnnotations?: TermAnnotation[] // ä»SSEè·å–ï¼šæœ¯è¯­æ ‡æ³¨
  createdAt: string       // å‰ç«¯ç”Ÿæˆï¼šåˆ›å»ºæ—¶é—´
  updatedAt: string       // å‰ç«¯ç”Ÿæˆï¼šæ›´æ–°æ—¶é—´
}
```

### å®Œæ•´æµç¨‹

```
1. ç”¨æˆ·é€‰æ‹©æ–‡ä»¶
   â†“ å‰ç«¯ç”Ÿæˆ
   TreeNode { id, name, fileType, status: 'pending' }

2. ä¸Šä¼ æ–‡ä»¶åˆ°åç«¯
   â†“ åç«¯è¿”å›
   { status: 'success', taskId: 'task_123' }

3. å‰ç«¯æ›´æ–°çŠ¶æ€
   â†“ å‰ç«¯æ›´æ–°
   TreeNode { status: 'processing' }

4. SSEæŸ¥è¯¢è¿›åº¦
   â†“ åç«¯æµå¼è¿”å›
   { status: 'processing', progress: 60 }
   { status: 'completed', result: { originalMarkdown, translatedMarkdown, zipUrl, termAnnotations } }

5. å‰ç«¯ç«‹å³æ˜¾ç¤ºæ–‡æœ¬
   â†“ å‰ç«¯æ˜¾ç¤º
   æ˜¾ç¤º originalMarkdown å’Œ translatedMarkdownï¼Œåº”ç”¨ termAnnotations é«˜äº®

6. å‰ç«¯å¼‚æ­¥ä¸‹è½½ZIP
   â†“ å‰ç«¯ä¸‹è½½
   fetch(zipUrl) â†’ ZIPåŒ…

7. å‰ç«¯è§£å‹å¹¶ç¼“å­˜å›¾ç‰‡
   â†“ å‰ç«¯å¤„ç†
   è§£å‹ZIP â†’ éå†imagesç›®å½• â†’ ä¸ºæ¯ä¸ªå›¾ç‰‡åˆ›å»ºblobUrl â†’ IndexedDBç¼“å­˜

8. å‰ç«¯æ›¿æ¢å›¾ç‰‡è·¯å¾„
   â†“ å‰ç«¯æ›¿æ¢
   ./images/ml.png â†’ blob:http://localhost:5174/uuid

9. å‰ç«¯ä¿å­˜ç¿»è¯‘è®°å½•
   â†“ å‰ç«¯åˆ›å»º
   TranslationRecord { id, title, originalText, translatedText, termAnnotations, ... }

10. å‰ç«¯æ›´æ–°æ–‡ä»¶çŠ¶æ€
    â†“ å‰ç«¯æ›´æ–°
    TreeNode { status: 'completed', translationId: record.id }
```

---

## ğŸ“‹ å­—æ®µèŒè´£æ€»ç»“

| æ•°æ®ç±»å‹ | èŒè´£ | æä¾›æ–¹ | å­˜å‚¨ä½ç½® |
|---------|------|--------|----------|
| **TreeNode** | æ–‡ä»¶æ ‘ç»“æ„å’ŒçŠ¶æ€ç®¡ç† | å‰ç«¯ç”Ÿæˆ/ç®¡ç† | å‰ç«¯å†…å­˜ + localStorage |
| **TranslationRecord** | ç¿»è¯‘å†…å®¹å­˜å‚¨ | å‰ç«¯ä»SSEè·å–åå­˜å‚¨ | IndexedDB/localStorage |
| **UploadResponse** | ä¸Šä¼ ç»“æœç¡®è®¤ | åç«¯æä¾› | APIå“åº” |
| **TaskProgressResponse** | ç¿»è¯‘è¿›åº¦å’Œç»“æœ | åç«¯æµå¼æä¾› | SSEæµ |
| **TermAnnotation** | æœ¯è¯­æ ‡æ³¨ä¿¡æ¯ | åç«¯æä¾› | SSEå“åº” |
| **ZIPåŒ…** | å›¾ç‰‡èµ„æº | åç«¯ç”Ÿæˆï¼Œå‰ç«¯ä¸‹è½½ | åç«¯æ–‡ä»¶ç³»ç»Ÿ â†’ å‰ç«¯å†…å­˜ |

---

## âœ… MVPé˜¶æ®µå¯¹é½æ¸…å•

**åç«¯éœ€è¦æä¾›çš„ï¼š**
- âœ… `POST /api/task/upload` - æ–‡ä»¶ä¸Šä¼ ï¼Œè¿”å›taskId
- âœ… `GET /api/task/progress` - SSEè¿›åº¦æŸ¥è¯¢ï¼Œè¿”å›zipUrl
- âœ… `GET /api/files/assets/{taskId}_assets.zip` - ZIPåŒ…ä¸‹è½½

**å‰ç«¯æœ¬åœ°ç®¡ç†çš„ï¼š**
- âœ… æ–‡ä»¶æ ‘ç»“æ„ï¼ˆTreeNodeï¼‰
- âœ… æ–‡ä»¶çŠ¶æ€ç®¡ç†
- âœ… ç¿»è¯‘è®°å½•å­˜å‚¨
- âœ… æœ¯è¯­æ ‡æ³¨å¤„ç†å’Œæ˜¾ç¤º
- âœ… ZIPè§£å‹å’Œå›¾ç‰‡ç¼“å­˜ï¼ˆIndexedDBï¼‰- æ— éœ€metadata.jsonï¼Œç›´æ¥éå†imagesç›®å½•
- âœ… Markdownè·¯å¾„æ›¿æ¢é€»è¾‘ - æ ¹æ®æ–‡ä»¶åè‡ªåŠ¨æ˜ å°„

**MVPç®€åŒ–ï¼š**
- ğŸ”„ æ— ä»¤ç‰ŒéªŒè¯ï¼ˆç›´æ¥URLä¸‹è½½ZIPï¼‰
- ğŸ”„ æ— å›¾ç‰‡å•ç‹¬ä¸‹è½½æ¥å£ï¼ˆç»Ÿä¸€ZIPåŒ…ï¼‰
- ğŸ”„ æ— å¤æ‚æƒé™æ§åˆ¶


