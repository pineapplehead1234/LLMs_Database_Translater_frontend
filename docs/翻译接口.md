# ç¿»è¯‘åº”ç”¨APIæ¥å£æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **é¡¹ç›®åç§°**: ç¿»è¯‘åº”ç”¨ API
- **ç‰ˆæœ¬**: 1.0.0
- **Base URL**: `http://localhost:8000`
- **Content-Type**: `multipart/form-data` (ä¸Šä¼ ) / `text/event-stream` (SSE)
- **ç¿»è¯‘æ–¹å‘é»˜è®¤**: è‹±æ–‡(en) â†’ ä¸­æ–‡(zh)
- **è®¤è¯**: æ— éœ€ç™»å½•

---

## ğŸ”„ æ¥å£è®¾è®¡åŸåˆ™

### å‰ç«¯æœ¬åœ°ç®¡ç† vs åç«¯æ•°æ®æä¾›

**å‰ç«¯æœ¬åœ°ç®¡ç†ï¼ˆå‰ç«¯è‡ªè¡Œå¤„ç†ï¼‰ï¼š**
- æ–‡ä»¶æ ‘ç»“æ„ (`TreeNode`)
- æ–‡ä»¶çŠ¶æ€ç®¡ç†
- ç¿»è¯‘è®°å½•å­˜å‚¨ (`TranslationRecord`)
- æ–‡ä»¶å¤¹ç®¡ç†
- IndexedDBç¼“å­˜

**åç«¯æ•°æ®æä¾›ï¼ˆAPIæ¥å£ï¼‰ï¼š**
- ç¿»è¯‘ç»“æœï¼ˆMarkdown + å›¾ç‰‡ + æœ¯è¯­ï¼‰
- ä»»åŠ¡è¿›åº¦çŠ¶æ€
- å¼‚æ­¥ä»»åŠ¡ID

---

## ğŸ“¤ æ–‡ä»¶ä¸Šä¼ æ¥å£ï¼ˆå¼‚æ­¥ï¼‰

### POST /api/task/upload

**åŠŸèƒ½æè¿°**: ä¸Šä¼ æ–‡ä»¶å¹¶å¯åŠ¨å¼‚æ­¥ç¿»è¯‘ä»»åŠ¡

**æ”¯æŒæ ¼å¼**: PDF, DOCX, Markdown (.md)

---

### è¯·æ±‚å‚æ•°ï¼ˆmultipart/form-dataï¼‰

| å‚æ•°å | ç±»å‹ | æ˜¯å¦å¿…éœ€ | è¯´æ˜ | æä¾›æ–¹ |
|--------|------|---------|------|--------|
| file | File | âœ… å¿…éœ€ | ä¸Šä¼ çš„æ–‡ä»¶ | å‰ç«¯ |
| target_lang | string | âœ… å¿…éœ€ | ç›®æ ‡è¯­è¨€ï¼ˆå¦‚ 'ch'ï¼‰ | å‰ç«¯ |
| strategy | string | âŒ å¯é€‰ | ç¿»è¯‘ç­–ç•¥ï¼ˆé»˜è®¤ 'normal'ï¼‰ | å‰ç«¯ |
| client_request_id | string | âŒ å¯é€‰ | å®¢æˆ·ç«¯è¯·æ±‚æ ‡è¯† | å‰ç«¯ |

---

### è¯·æ±‚ç¤ºä¾‹

```javascript
const formData = new FormData()
formData.append('file', file)
formData.append('target_lang', 'ch')
formData.append('strategy', 'normal')
formData.append('client_request_id', file.name)

fetch('/apiA/api/task/upload', {
  method: 'POST',
  body: formData
})
```

---

### å“åº”æ ¼å¼ï¼ˆç®€å•å“åº”ï¼‰

```typescript
interface UploadResponse {
  status: 'success' | 'error'
  taskId?: string    // æˆåŠŸæ—¶è¿”å›å¼‚æ­¥ä»»åŠ¡ID
  error?: string     // å¤±è´¥æ—¶è¿”å›é”™è¯¯ä¿¡æ¯
}
```

**æˆåŠŸå“åº”ï¼š**
```json
{
  "status": "success",
  "taskId": "task_123_456789"
}
```

**å¤±è´¥å“åº”ï¼š**
```json
{
  "status": "error",
  "error": "æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶"
}
```

---

## ğŸ“¡ SSEè¿›åº¦æŸ¥è¯¢æ¥å£

### GET /api/task/query?taskId={taskId}

**åŠŸèƒ½æè¿°**: é€šè¿‡SSEæµå®æ—¶è·å–ç¿»è¯‘è¿›åº¦å’Œç»“æœ

---

### SSEå“åº”æ ¼å¼

```typescript
interface TaskProgressResponse {
  status: 'pending' | 'processing' | 'success' | 'error'
  progress?: number

  // ç¿»è¯‘å®Œæˆæ—¶æä¾›
  originalMarkdown?: string
  translatedMarkdown?: string
  images?: ImageInfo[]
  termAnnotations?: TermAnnotation[]

  error?: string
}
```

---

### SSEå“åº”ç¤ºä¾‹

#### 1. ä»»åŠ¡å¼€å§‹
```json
{
  "status": "pending",
  "progress": 0
}
```

#### 2. å¤„ç†ä¸­
```json
{
  "status": "processing",
  "progress": 60
}
```

#### 3. ç¿»è¯‘å®Œæˆ
```json
{
  "status": "success",
  "progress": 100,
  "originalMarkdown": "# Machine Learning\n\nML is important.\n\n![Diagram](./images/ml.png)",
  "translatedMarkdown": "# æœºå™¨å­¦ä¹ \n\næœºå™¨å­¦ä¹ å¾ˆé‡è¦ã€‚\n\n![Diagram](./images/ml.png)",
  "images": [
    {
      "originalPath": "./images/ml.png",
      "fileId": "task_123_001_ml.png",
      "url": "/api/files/image/task_123_001_ml.png"
    }
  ],
  "termAnnotations": [
    {
      "term": "Machine Learning",
      "translation": "æœºå™¨å­¦ä¹ ",
      "position": {
        "start": 2,
        "end": 17
      }
    }
  ]
}
```

#### 4. å¤„ç†å¤±è´¥
```json
{
  "status": "error",
  "error": "æ–‡æ¡£è§£æå¤±è´¥ï¼šä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼"
}
```

---

## ğŸ–¼ï¸ å›¾ç‰‡ä¸‹è½½æ¥å£

### GET /api/files/image/{fileId}

**åŠŸèƒ½æè¿°**: ä¸‹è½½ç¿»è¯‘åçš„å›¾ç‰‡æ–‡ä»¶

**å“åº”**: å›¾ç‰‡äºŒè¿›åˆ¶æ•°æ®ï¼ˆContent-Type æ ¹æ®å›¾ç‰‡ç±»å‹è®¾ç½®ï¼‰

---

### å›¾ç‰‡æ•°æ®ç»“æ„

```typescript
interface ImageInfo {
  originalPath: string    // Markdownä¸­çš„åŸå§‹è·¯å¾„ï¼Œå¦‚ "./images/ml.png"
  fileId: string          // å”¯ä¸€æ ‡è¯†ï¼Œå¦‚ "task_123_001_ml.png"
  url: string             // ä¸‹è½½è·¯å¾„ï¼Œå¦‚ "/api/files/image/task_123_001_ml.png"
}
```

---

## ğŸ“Š æ•°æ®æµè½¬è¯´æ˜

### å‰ç«¯æ–‡ä»¶æ ‘ç®¡ç†ï¼ˆæœ¬åœ°ï¼‰

```typescript
// å‰ç«¯æœ¬åœ°ç»´æŠ¤çš„æ–‡ä»¶æ ‘ç»“æ„
interface TreeNode {
  id: string              // å‰ç«¯ç”Ÿæˆï¼šå”¯ä¸€ID
  name: string            // å‰ç«¯ç”Ÿæˆï¼šæ˜¾ç¤ºåç§°
  type: 'folder' | 'file' // å‰ç«¯ç”Ÿæˆï¼šèŠ‚ç‚¹ç±»å‹
  fileType?: 'pdf' | 'docx' | 'md'  // å‰ç«¯ç”Ÿæˆï¼šæ–‡ä»¶ç±»å‹
  status?: 'pending' | 'processing' | 'completed' | 'error'  // å‰ç«¯ç®¡ç†ï¼šç¿»è¯‘çŠ¶æ€
  parentId: string | null // å‰ç«¯ç®¡ç†ï¼šçˆ¶èŠ‚ç‚¹
  children?: TreeNode[]   // å‰ç«¯ç®¡ç†ï¼šå­èŠ‚ç‚¹
  translationId?: string  // å‰ç«¯å…³è”ï¼šç¿»è¯‘è®°å½•ID
}
```

### å‰ç«¯ç¿»è¯‘è®°å½•å­˜å‚¨ï¼ˆæœ¬åœ°ï¼‰

```typescript
// å‰ç«¯æœ¬åœ°å­˜å‚¨çš„ç¿»è¯‘ç»“æœ
interface TranslationRecord {
  id: string              // å‰ç«¯ç”Ÿæˆï¼šè®°å½•ID
  title: string           // å‰ç«¯ç”Ÿæˆï¼šæ ‡é¢˜
  originalText: string    // ä»SSEè·å–ï¼šåŸæ–‡
  translatedText: string  // ä»SSEè·å–ï¼šè¯‘æ–‡
  sourceLang: string      // å‰ç«¯è®¾ç½®ï¼šæºè¯­è¨€
  targetLang: string      // å‰ç«¯è®¾ç½®ï¼šç›®æ ‡è¯­è¨€
  folderPath: string      // å‰ç«¯ç®¡ç†ï¼šæ–‡ä»¶å¤¹è·¯å¾„
  createdAt: string       // å‰ç«¯ç”Ÿæˆï¼šåˆ›å»ºæ—¶é—´
  updatedAt: string       // å‰ç«¯ç”Ÿæˆï¼šæ›´æ–°æ—¶é—´
}
```

### å®Œæ•´æµç¨‹

```
1. ç”¨æˆ·é€‰æ‹©æ–‡ä»¶
   â†“ å‰ç«¯ç”Ÿæˆ
   TreeNode { id, name, fileType, status: 'pending' }

2. ä¸Šä¼ æ–‡ä»¶åˆ°åç«¯
   â†“ åç«¯è¿”å›
   { status: 'success', taskId: 'task_123' }

3. å‰ç«¯æ›´æ–°çŠ¶æ€
   â†“ å‰ç«¯æ›´æ–°
   TreeNode { status: 'processing' }

4. SSEæŸ¥è¯¢è¿›åº¦
   â†“ åç«¯æµå¼è¿”å›
   { status: 'processing', progress: 60 }
   { status: 'success', originalMarkdown, translatedMarkdown, images, termAnnotations }

5. å‰ç«¯å¤„ç†å›¾ç‰‡ç¼“å­˜
   â†“ å‰ç«¯ä¸‹è½½å¹¶ç¼“å­˜å›¾ç‰‡
   IndexedDBå­˜å‚¨å›¾ç‰‡Blobå’ŒblobUrl

6. å‰ç«¯æ›¿æ¢Markdownè·¯å¾„
   â†“ å‰ç«¯æ›¿æ¢
   ./images/ml.png â†’ blob:http://localhost:5174/uuid

7. å‰ç«¯ä¿å­˜ç¿»è¯‘è®°å½•
   â†“ å‰ç«¯åˆ›å»º
   TranslationRecord { id, title, originalText, translatedText, ... }

8. å‰ç«¯æ›´æ–°æ–‡ä»¶çŠ¶æ€
   â†“ å‰ç«¯æ›´æ–°
   TreeNode { status: 'completed', translationId: record.id }
```

---

## ğŸ“‹ å­—æ®µèŒè´£æ€»ç»“

| æ•°æ®ç±»å‹ | èŒè´£ | æä¾›æ–¹ | å­˜å‚¨ä½ç½® |
|---------|------|--------|----------|
| **TreeNode** | æ–‡ä»¶æ ‘ç»“æ„å’ŒçŠ¶æ€ç®¡ç† | å‰ç«¯ç”Ÿæˆ/ç®¡ç† | å‰ç«¯å†…å­˜ + localStorage |
| **TranslationRecord** | ç¿»è¯‘å†…å®¹å­˜å‚¨ | å‰ç«¯ä»SSEè·å–åå­˜å‚¨ | IndexedDB/localStorage |
| **UploadResponse** | ä¸Šä¼ ç»“æœç¡®è®¤ | åç«¯æä¾› | APIå“åº” |
| **TaskProgressResponse** | ç¿»è¯‘è¿›åº¦å’Œç»“æœ | åç«¯æµå¼æä¾› | SSEæµ |
| **ImageInfo** | å›¾ç‰‡å…ƒä¿¡æ¯ | åç«¯æä¾› | SSEå“åº” |
| **CachedImage** | å›¾ç‰‡ç¼“å­˜ | å‰ç«¯ä¸‹è½½åå­˜å‚¨ | IndexedDB |

---

## âœ… å¯¹é½æ¸…å•

**åç«¯éœ€è¦æä¾›çš„ï¼š**
- âœ… `POST /api/task/upload` - æ–‡ä»¶ä¸Šä¼ ï¼Œè¿”å›taskId
- âœ… `GET /api/task/query` - SSEè¿›åº¦æŸ¥è¯¢
- âœ… `GET /api/files/image/{fileId}` - å›¾ç‰‡ä¸‹è½½

**å‰ç«¯æœ¬åœ°ç®¡ç†çš„ï¼š**
- âœ… æ–‡ä»¶æ ‘ç»“æ„ï¼ˆTreeNodeï¼‰
- âœ… æ–‡ä»¶çŠ¶æ€ç®¡ç†
- âœ… ç¿»è¯‘è®°å½•å­˜å‚¨
- âœ… å›¾ç‰‡ç¼“å­˜ï¼ˆIndexedDBï¼‰
- âœ… è·¯å¾„æ›¿æ¢é€»è¾‘


