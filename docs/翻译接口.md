# ç¿»è¯‘åº”ç”¨APIæ¥å£æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **é¡¹ç›®åç§°**: ç¿»è¯‘åº”ç”¨ API
- **ç‰ˆæœ¬**: 1.0.0 - MVP
- **Base URL**: `http://localhost:8000`
- **Content-Type**: `multipart/form-data` (ä¸Šä¼ ) / `application/json` (æŸ¥è¯¢)
- **ç¿»è¯‘æ–¹å‘é»˜è®¤**: è‹±æ–‡(en) â†’ ä¸­æ–‡(zh)
- **è®¤è¯**: æ— éœ€ç™»å½•ï¼ˆMVPé˜¶æ®µï¼‰

---

## ğŸ”„ æ¥å£è®¾è®¡åŸåˆ™

### å‰ç«¯æœ¬åœ°ç®¡ç† vs åç«¯æ•°æ®æä¾›

**å‰ç«¯æœ¬åœ°ç®¡ç†ï¼ˆå‰ç«¯è‡ªè¡Œå¤„ç†ï¼‰ï¼š**
- æ–‡ä»¶æ ‘ç»“æ„ (`TreeNode`)
- æ–‡ä»¶çŠ¶æ€ç®¡ç†
- ç¿»è¯‘è®°å½•å­˜å‚¨ (`TranslationRecord`)
- æ–‡ä»¶å¤¹ç®¡ç†
- IndexedDBç¼“å­˜

**åç«¯æ•°æ®æä¾›ï¼ˆAPIæ¥å£ï¼‰ï¼š**
- ç¿»è¯‘ç»“æœï¼ˆMarkdown + ZIPåŒ…ä¸‹è½½åœ°å€ï¼‰
- ä»»åŠ¡è¿›åº¦çŠ¶æ€
- å¼‚æ­¥ä»»åŠ¡ID

---

## ğŸ“¤ æ–‡ä»¶ä¸Šä¼ æ¥å£ï¼ˆå¼‚æ­¥ï¼‰

### POST /api/task/upload

**åŠŸèƒ½æè¿°**: ä¸Šä¼ æ–‡ä»¶å¹¶å¯åŠ¨å¼‚æ­¥ç¿»è¯‘ä»»åŠ¡

**æ”¯æŒæ ¼å¼**: PDF, DOCX, Markdown (.md)

---

### è¯·æ±‚å‚æ•°ï¼ˆmultipart/form-dataï¼‰

| å‚æ•°å | ç±»å‹ | æ˜¯å¦å¿…éœ€ | è¯´æ˜ | æä¾›æ–¹ |
|--------|------|---------|------|--------|
| file | File | âœ… å¿…éœ€ | ä¸Šä¼ çš„æ–‡ä»¶ | å‰ç«¯ |
| targetLang | string | âŒ å¯é€‰ | ç›®æ ‡è¯­è¨€ï¼ˆé»˜è®¤ 'ch'ï¼‰ | å‰ç«¯ |
| strategy | string | âŒ å¯é€‰ | ç¿»è¯‘ç­–ç•¥ï¼ˆ'fast'/'normal'/'thinking'ï¼Œé»˜è®¤ 'normal'ï¼‰ | å‰ç«¯ |
| clientRequestId | string | âŒ å¯é€‰ | å®¢æˆ·ç«¯è¯·æ±‚ID | å‰ç«¯ |

---

### è¯·æ±‚ç¤ºä¾‹

```javascript
const formData = new FormData()
formData.append('file', file)
formData.append('targetLang', 'ch')
formData.append('strategy', 'normal')
formData.append('clientRequestId', 'client_123_456789') // å¯é€‰

fetch('/api/task/upload', {
  method: 'POST',
  body: formData
})
```

---

### å“åº”æ ¼å¼ï¼ˆç®€å•å“åº”ï¼‰

```typescript
interface UploadResponse {
  status: 'success' | 'error'
  taskId?: string    // æˆåŠŸæ—¶è¿”å›å¼‚æ­¥ä»»åŠ¡ID
  error?: string     // å¤±è´¥æ—¶è¿”å›é”™è¯¯ä¿¡æ¯
}
```

**æˆåŠŸå“åº”ï¼š**
```json
{
  "status": "success",
  "taskId": "xxxxx"
}
```

**å¤±è´¥å“åº”ï¼š**
```json
{
  "status": "error",
  "error": "æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶"
}
```

---

## ğŸ“¡ ä»»åŠ¡æŸ¥è¯¢æ¥å£

### GET /api/task/query

**åŠŸèƒ½æè¿°**: æŸ¥è¯¢ç¿»è¯‘ä»»åŠ¡çŠ¶æ€å’Œç»“æœ

**è¯·æ±‚å‚æ•°ï¼š**
- `taskId` (å¿…éœ€): ä»»åŠ¡IDï¼ˆæŸ¥è¯¢å‚æ•°æˆ–è¯·æ±‚ä½“ï¼‰

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```javascript
fetch('/api/task/query?taskId=xxxxx', {
  method: 'GET'
})
```

---

### å“åº”æ ¼å¼

```typescript
// æœªå®Œæˆæ—¶çš„å“åº”
interface TaskQueryResponsePending {
  status: 'pending' | 'processing' | 'error'
  error?: string
}

// å®Œæˆæ—¶çš„å“åº”
interface TaskQueryResponseCompleted {
  fileId: string              // æ–‡ä»¶IDï¼ˆç­‰äºtaskIdï¼‰
  status: 'success'
  originalMarkdown: Record<string, string>  // åˆ†æ®µåŸæ–‡ {"1": "...", "2": "..."}
  translatedMarkdown: Record<string, string>  // åˆ†æ®µè¯‘æ–‡ {"1": "...", "2": "..."}
  termAnnotations: TermAnnotation[]  // æœ¯è¯­æ ‡æ³¨ï¼ˆåˆ†æ®µæ ¼å¼ï¼‰
  clientRequestId?: string     // å®¢æˆ·ç«¯è¯·æ±‚ID
}

// æœ¯è¯­æ ‡æ³¨ç»“æ„ï¼ˆåˆ†æ®µæ ¼å¼ï¼‰
interface TermAnnotation {
  [segmentId: string]: Array<Record<string, string>>  // {"1": [{"word1": "mean1"}, ...]}
}
```

---

### å“åº”ç¤ºä¾‹

#### 1. ä»»åŠ¡æœªå®Œæˆï¼ˆpending/processingï¼‰
```json
{
  "status": "pending",
  "error": null
}
```

æˆ–

```json
{
  "status": "processing"
}
```

#### 2. ä»»åŠ¡å®Œæˆï¼ˆsuccessï¼‰
```json
{
  "fileId": "xxxxx",
  "status": "success",
  "originalMarkdown": {
    "1": "# Machine Learning\n\nML is important.",
    "2": "![Diagram](./images/ml.png)"
  },
  "translatedMarkdown": {
    "1": "# æœºå™¨å­¦ä¹ \n\næœºå™¨å­¦ä¹ å¾ˆé‡è¦ã€‚",
    "2": "![Diagram](./images/ml.png)"
  },
  "termAnnotations": [
    {
      "1": [
        {"Machine Learning": "æœºå™¨å­¦ä¹ "},
        {"ML": "æœºå™¨å­¦ä¹ "}
      ]
    },
    {
      "2": []
    }
  ],
  "clientRequestId": "client_123_456789"
}
```

#### 3. å¤„ç†å¤±è´¥ï¼ˆerrorï¼‰
```json
{
  "status": "error",
  "error": "æ–‡æ¡£è§£æå¤±è´¥ï¼šä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼"
}
```

---

## ğŸ“¦ ZIPèµ„æºä¸‹è½½æ¥å£

### GET /api/files/assets/{taskId}_assets.zip

**åŠŸèƒ½æè¿°**: ä¸‹è½½åŒ…å«æ–‡æ¡£ä¸­æ‰€æœ‰å›¾ç‰‡çš„ZIPå‹ç¼©åŒ…

**URLå‚æ•°ï¼š**
- `taskId`: ä»»åŠ¡IDï¼ˆç”¨äºæ„é€ æ–‡ä»¶åï¼‰

**å“åº”æ ¼å¼ï¼š**

**æœªå®Œæˆæˆ–é”™è¯¯æ—¶ï¼ˆè¿”å›JSONï¼‰ï¼š**
```json
{
  "status": "pending" | "processing" | "error" | "notfound"
}
```

**å®Œæˆæ—¶ï¼ˆè¿”å›ZIPæ–‡ä»¶ï¼‰ï¼š**
- Content-Type: `application/zip`
- Content-Disposition: `attachment; filename="{taskId}_assets.zip"`
- Body: ZIPæ–‡ä»¶äºŒè¿›åˆ¶æ•°æ®ï¼ˆFileResponseï¼‰

**å‰ç«¯å¤„ç†ç¤ºä¾‹ï¼š**
```typescript
async function downloadZip(taskId: string) {
  const response = await fetch(`/api/files/assets/${taskId}_assets.zip`)
  const contentType = response.headers.get('content-type')
  
  if (contentType?.includes('application/json')) {
    // è¿”å›çš„æ˜¯JSONçŠ¶æ€
    const data = await response.json()
    console.log('ä»»åŠ¡çŠ¶æ€:', data.status)
    // éœ€è¦ç­‰å¾…æˆ–é‡è¯•
  } else {
    // è¿”å›çš„æ˜¯ZIPæ–‡ä»¶
    const blob = await response.blob()
    // å¤„ç†ZIPæ–‡ä»¶
  }
}
```

---

### ZIPåŒ…å†…éƒ¨ç»“æ„

**æ–‡ä»¶ç»„ç»‡ï¼š**
```
{taskId}_assets.zip/
â””â”€â”€ images/              # å›¾ç‰‡ç›®å½•
    â”œâ”€â”€ flowchart.png   # ä¿æŒåŸå§‹æ–‡ä»¶å
    â”œâ”€â”€ diagram.jpg
    â””â”€â”€ chart.png
```

**æ˜ å°„è§„åˆ™ï¼š**
- ZIPå†…è·¯å¾„ï¼š`images/{filename}`
- Markdownè·¯å¾„ï¼š`./images/{filename}`
- å‰ç«¯è‡ªåŠ¨æ ¹æ®æ–‡ä»¶åæ˜ å°„ï¼Œæ— éœ€é¢å¤–å…ƒæ•°æ®æ–‡ä»¶

**å‰ç«¯å¤„ç†ç¤ºä¾‹ï¼š**
```typescript
// æ— éœ€metadata.jsonï¼Œç›´æ¥éå†ZIPåŒ…
async function processZipPackage(zipBlob: Blob) {
  const zip = await JSZip.loadAsync(zipBlob)
  const pathMapping: Record<string, string> = {}

  // éå†imagesç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
  Object.keys(zip.files).forEach(async (path) => {
    if (path.startsWith('images/') && !path.endsWith('/')) {
      const filename = path.replace('images/', '')
      const file = zip.files[path]

      // åˆ›å»ºblob URL
      const blob = await file.async('blob')
      const blobUrl = URL.createObjectURL(blob)

      // å»ºç«‹æ˜ å°„å…³ç³»ï¼š./images/filename â†’ blobUrl
      pathMapping[`./images/${filename}`] = blobUrl

      // ç¼“å­˜åˆ°IndexedDB
      await ImageCache.saveImage(`img_${Date.now()}`, blob)
    }
  })

  return pathMapping
}
```

---

## ğŸ“Š æ•°æ®æµè½¬è¯´æ˜

### å‰ç«¯æ–‡ä»¶æ ‘ç®¡ç†ï¼ˆæœ¬åœ°ï¼‰

```typescript
// å‰ç«¯æœ¬åœ°ç»´æŠ¤çš„æ–‡ä»¶æ ‘ç»“æ„
interface TreeNode {
  id: string              // å‰ç«¯ç”Ÿæˆï¼šå”¯ä¸€ID
  name: string            // å‰ç«¯ç”Ÿæˆï¼šæ˜¾ç¤ºåç§°
  type: 'folder' | 'file' // å‰ç«¯ç”Ÿæˆï¼šèŠ‚ç‚¹ç±»å‹
  fileType?: 'pdf' | 'docx' | 'md'  // å‰ç«¯ç”Ÿæˆï¼šæ–‡ä»¶ç±»å‹
  status?: 'pending' | 'processing' | 'completed' | 'error'  // å‰ç«¯ç®¡ç†ï¼šç¿»è¯‘çŠ¶æ€
  parentId: string | null // å‰ç«¯ç®¡ç†ï¼šçˆ¶èŠ‚ç‚¹
  children?: TreeNode[]   // å‰ç«¯ç®¡ç†ï¼šå­èŠ‚ç‚¹
  translationId?: string  // å‰ç«¯å…³è”ï¼šç¿»è¯‘è®°å½•ID
}
```

### å‰ç«¯ç¿»è¯‘è®°å½•å­˜å‚¨ï¼ˆæœ¬åœ°ï¼‰

```typescript
// å‰ç«¯æœ¬åœ°å­˜å‚¨çš„ç¿»è¯‘ç»“æœ
interface TranslationRecord {
  id: string              // å‰ç«¯ç”Ÿæˆï¼šè®°å½•ID
  title: string           // å‰ç«¯ç”Ÿæˆï¼šæ ‡é¢˜
  originalText: string    // ä»APIè·å–ååˆå¹¶ï¼šåŸæ–‡ï¼ˆåˆ†æ®µå¯¹è±¡åˆå¹¶ä¸ºå­—ç¬¦ä¸²ï¼‰
  translatedText: string  // ä»APIè·å–ååˆå¹¶ï¼šè¯‘æ–‡ï¼ˆåˆ†æ®µå¯¹è±¡åˆå¹¶ä¸ºå­—ç¬¦ä¸²ï¼‰
  originalMarkdownSegmented?: Record<string, string>  // åŸå§‹åˆ†æ®µæ•°æ®
  translatedMarkdownSegmented?: Record<string, string>  // åŸå§‹åˆ†æ®µæ•°æ®
  sourceLang: string      // å‰ç«¯è®¾ç½®ï¼šæºè¯­è¨€
  targetLang: string      // å‰ç«¯è®¾ç½®ï¼šç›®æ ‡è¯­è¨€
  folderPath: string        // å‰ç«¯ç®¡ç†ï¼šæ–‡ä»¶å¤¹è·¯å¾„
  termAnnotations?: TermAnnotation[] // ä»APIè·å–ï¼šæœ¯è¯­æ ‡æ³¨ï¼ˆåˆ†æ®µæ ¼å¼ï¼‰
  createdAt: string       // å‰ç«¯ç”Ÿæˆï¼šåˆ›å»ºæ—¶é—´
  updatedAt: string       // å‰ç«¯ç”Ÿæˆï¼šæ›´æ–°æ—¶é—´
}

// æœ¯è¯­æ ‡æ³¨ç»“æ„ï¼ˆåˆ†æ®µæ ¼å¼ï¼‰
interface TermAnnotation {
  [segmentId: string]: Array<Record<string, string>>  // {"1": [{"word": "translation"}, ...]}
}
```

### å®Œæ•´æµç¨‹

```
1. ç”¨æˆ·é€‰æ‹©æ–‡ä»¶
   â†“ å‰ç«¯ç”Ÿæˆ
   TreeNode { id, name, fileType, status: 'pending' }

2. ä¸Šä¼ æ–‡ä»¶åˆ°åç«¯
   â†“ POST /api/task/upload
   { status: 'success', taskId: 'xxxxx' }

3. å‰ç«¯æ›´æ–°çŠ¶æ€
   â†“ å‰ç«¯æ›´æ–°
   TreeNode { status: 'processing' }

4. æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ï¼ˆè½®è¯¢ï¼‰
   â†“ GET /api/task/query?taskId=xxxxx
   { status: 'processing' } æˆ–
   { status: 'success', fileId, originalMarkdown: {"1":"...", "2":"..."}, ... }

5. å‰ç«¯å¤„ç†åˆ†æ®µæ•°æ®
   â†“ å‰ç«¯è½¬æ¢
   å°†åˆ†æ®µå¯¹è±¡ {"1":"...", "2":"..."} åˆå¹¶ä¸ºå®Œæ•´å­—ç¬¦ä¸²

6. å‰ç«¯ç«‹å³æ˜¾ç¤ºæ–‡æœ¬
   â†“ å‰ç«¯æ˜¾ç¤º
   æ˜¾ç¤ºåˆå¹¶åçš„åŸæ–‡å’Œè¯‘æ–‡ï¼Œåº”ç”¨åˆ†æ®µæœ¯è¯­æ ‡æ³¨é«˜äº®

7. å‰ç«¯å¼‚æ­¥ä¸‹è½½ZIP
   â†“ GET /api/files/assets/{taskId}_assets.zip
   æ£€æŸ¥å“åº”ç±»å‹ï¼šJSONçŠ¶æ€æˆ–ZIPæ–‡ä»¶

8. å‰ç«¯è§£å‹å¹¶ç¼“å­˜å›¾ç‰‡
   â†“ å‰ç«¯å¤„ç†
   è§£å‹ZIP â†’ éå†imagesç›®å½• â†’ ä¸ºæ¯ä¸ªå›¾ç‰‡åˆ›å»ºblobUrl â†’ IndexedDBç¼“å­˜

9. å‰ç«¯æ›¿æ¢å›¾ç‰‡è·¯å¾„
   â†“ å‰ç«¯æ›¿æ¢
   ./images/ml.png â†’ blob:http://localhost:5174/uuid

10. å‰ç«¯ä¿å­˜ç¿»è¯‘è®°å½•
    â†“ å‰ç«¯åˆ›å»º
    TranslationRecord { 
      id, title, 
      originalText: åˆå¹¶åçš„å­—ç¬¦ä¸²,
      translatedText: åˆå¹¶åçš„å­—ç¬¦ä¸²,
      originalMarkdownSegmented: åŸå§‹åˆ†æ®µå¯¹è±¡,
      translatedMarkdownSegmented: åŸå§‹åˆ†æ®µå¯¹è±¡,
      termAnnotations: åˆ†æ®µæœ¯è¯­æ ‡æ³¨,
      ... 
    }

11. å‰ç«¯æ›´æ–°æ–‡ä»¶çŠ¶æ€
    â†“ å‰ç«¯æ›´æ–°
    TreeNode { status: 'completed', translationId: record.id }
```

### å‰ç«¯å¤„ç†åˆ†æ®µæ•°æ®çš„å·¥å…·å‡½æ•°

```typescript
// å°†åˆ†æ®µå¯¹è±¡åˆå¹¶ä¸ºå®Œæ•´å­—ç¬¦ä¸²
function mergeSegmentedMarkdown(segmented: Record<string, string>): string {
  const segments = Object.keys(segmented)
    .sort((a, b) => parseInt(a) - parseInt(b))
    .map(key => segmented[key])
  return segments.join('\n\n')
}

// å¤„ç†æœ¯è¯­æ ‡æ³¨ï¼ˆåˆ†æ®µæ ¼å¼ï¼‰
function processTermAnnotations(
  termAnnotations: TermAnnotation[], 
  segmentId: string
): Array<{term: string, translation: string}> {
  const segmentAnnotations = termAnnotations.find(ann => ann[segmentId])
  if (!segmentAnnotations) return []
  
  return segmentAnnotations[segmentId].map(item => {
    const [term, translation] = Object.entries(item)[0]
    return { term, translation }
  })
}
```

---

## ğŸ“‹ å­—æ®µèŒè´£æ€»ç»“

| æ•°æ®ç±»å‹ | èŒè´£ | æä¾›æ–¹ | å­˜å‚¨ä½ç½® |
|---------|------|--------|----------|
| **TreeNode** | æ–‡ä»¶æ ‘ç»“æ„å’ŒçŠ¶æ€ç®¡ç† | å‰ç«¯ç”Ÿæˆ/ç®¡ç† | å‰ç«¯å†…å­˜ + localStorage |
| **TranslationRecord** | ç¿»è¯‘å†…å®¹å­˜å‚¨ | å‰ç«¯ä»APIè·å–åå­˜å‚¨ | IndexedDB/localStorage |
| **UploadResponse** | ä¸Šä¼ ç»“æœç¡®è®¤ | åç«¯æä¾› | APIå“åº” |
| **TaskQueryResponse** | ç¿»è¯‘è¿›åº¦å’Œç»“æœ | åç«¯æä¾› | APIå“åº”ï¼ˆGET /api/task/queryï¼‰ |
| **TermAnnotation** | æœ¯è¯­æ ‡æ³¨ä¿¡æ¯ï¼ˆåˆ†æ®µæ ¼å¼ï¼‰ | åç«¯æä¾› | APIå“åº” |
| **ZIPåŒ…** | å›¾ç‰‡èµ„æº | åç«¯ç”Ÿæˆï¼Œå‰ç«¯ä¸‹è½½ | åç«¯æ–‡ä»¶ç³»ç»Ÿ â†’ å‰ç«¯å†…å­˜ |

---

## âœ… MVPé˜¶æ®µå¯¹é½æ¸…å•

**åç«¯éœ€è¦æä¾›çš„ï¼š**
- âœ… `POST /api/task/upload` - æ–‡ä»¶ä¸Šä¼ ï¼Œè¿”å›taskId
- âœ… `GET /api/task/query` - ä»»åŠ¡æŸ¥è¯¢ï¼Œè¿”å›åˆ†æ®µMarkdownå’Œæœ¯è¯­æ ‡æ³¨
- âœ… `GET /api/files/assets/{taskId}_assets.zip` - ZIPåŒ…ä¸‹è½½ï¼ˆè¿”å›JSONçŠ¶æ€æˆ–ZIPæ–‡ä»¶ï¼‰

**å‰ç«¯æœ¬åœ°ç®¡ç†çš„ï¼š**
- âœ… æ–‡ä»¶æ ‘ç»“æ„ï¼ˆTreeNodeï¼‰
- âœ… æ–‡ä»¶çŠ¶æ€ç®¡ç†
- âœ… ç¿»è¯‘è®°å½•å­˜å‚¨
- âœ… åˆ†æ®µMarkdownæ•°æ®åˆå¹¶ï¼ˆå°† {"1":"...", "2":"..."} åˆå¹¶ä¸ºå­—ç¬¦ä¸²ï¼‰
- âœ… åˆ†æ®µæœ¯è¯­æ ‡æ³¨å¤„ç†å’Œæ˜¾ç¤º
- âœ… ä»»åŠ¡çŠ¶æ€è½®è¯¢ï¼ˆGET /api/task/queryï¼‰
- âœ… ZIPè§£å‹å’Œå›¾ç‰‡ç¼“å­˜ï¼ˆIndexedDBï¼‰- æ— éœ€metadata.jsonï¼Œç›´æ¥éå†imagesç›®å½•
- âœ… Markdownè·¯å¾„æ›¿æ¢é€»è¾‘ - æ ¹æ®æ–‡ä»¶åè‡ªåŠ¨æ˜ å°„
- âœ… ZIPä¸‹è½½å“åº”ç±»å‹åˆ¤æ–­ï¼ˆJSONçŠ¶æ€ vs ZIPæ–‡ä»¶ï¼‰

**MVPç®€åŒ–ï¼š**
- ğŸ”„ æ— ä»¤ç‰ŒéªŒè¯ï¼ˆç›´æ¥URLä¸‹è½½ZIPï¼‰
- ğŸ”„ æ— å›¾ç‰‡å•ç‹¬ä¸‹è½½æ¥å£ï¼ˆç»Ÿä¸€ZIPåŒ…ï¼‰
- ğŸ”„ æ— å¤æ‚æƒé™æ§åˆ¶


